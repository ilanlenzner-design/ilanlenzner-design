<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ilan Lenzner — AI Creative Specialist & Product Designer</title>
    <meta name="description" content="I design AI-powered tools that automate creative production. 20+ years at the intersection of AI, design, and engineering.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a0a;
            --bg-card: #141414;
            --text: #e5e5e5;
            --text-muted: #888;
            --text-dim: #555;
            --accent: #7c5cfc;
            --accent-2: #c084fc;
            --border: #222;
            --border-hover: #444;
            --radius: 12px;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            position: relative;
        }

        /* Canvas particle field */
        #dotfield {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* All content above the dot layers */
        nav, section, footer { position: relative; z-index: 1; }

        a { color: var(--accent-2); text-decoration: none; transition: color 0.2s; }
        a:hover { color: #e0c4ff; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }

        /* NAV */
        nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            padding: 16px 0;
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s;
        }
        nav.scrolled { border-bottom-color: var(--border); }
        nav .container { display: flex; justify-content: space-between; align-items: center; }
        .nav-logo { font-weight: 700; font-size: 18px; color: var(--text); letter-spacing: -0.5px; }
        .nav-links { display: flex; gap: 32px; }
        .nav-links a { color: var(--text-muted); font-size: 14px; font-weight: 500; }
        .nav-links a:hover { color: var(--text); }

        /* HERO */
        .hero {
            min-height: 100vh; display: flex; align-items: center;
            position: relative; overflow: hidden;
        }
        .hero-bg {
            position: absolute; inset: 0;
            background:
                radial-gradient(ellipse 80% 60% at 50% -20%, rgba(124,92,252,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 50%, rgba(192,132,252,0.06) 0%, transparent 50%);
        }
        .hero-content { position: relative; z-index: 1; max-width: 700px; }
        .hero-label {
            display: inline-block; font-size: 13px; font-weight: 600;
            letter-spacing: 2px; text-transform: uppercase;
            color: var(--accent); margin-bottom: 20px;
        }
        .hero h1 {
            font-size: clamp(40px, 7vw, 64px); font-weight: 700;
            line-height: 1.1; letter-spacing: -2px; color: #fff; margin-bottom: 20px;
        }
        .hero-desc {
            font-size: 18px; color: var(--text-muted); line-height: 1.7;
            max-width: 540px; margin-bottom: 36px;
        }
        .hero-links { display: flex; gap: 12px; flex-wrap: wrap; }

        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 24px; border-radius: 8px;
            font-size: 14px; font-weight: 600; transition: all 0.2s;
            border: none; cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #fff;
        }
        .btn-primary:hover {
            color: #fff; transform: translateY(-1px);
            box-shadow: 0 8px 30px rgba(124,92,252,0.3);
        }
        .btn-outline {
            background: transparent; color: var(--text-muted);
            border: 1px solid var(--border);
        }
        .btn-outline:hover {
            color: var(--text); border-color: var(--border-hover);
            background: var(--bg-card);
        }

        /* SECTIONS */
        section { padding: 100px 0; }
        .section-label {
            font-size: 13px; font-weight: 600; letter-spacing: 2px;
            text-transform: uppercase; color: var(--accent); margin-bottom: 12px;
        }
        .section-title {
            font-size: clamp(28px, 4vw, 40px); font-weight: 700;
            letter-spacing: -1px; color: #fff; margin-bottom: 48px;
        }

        /* PROJECTS */
        .projects-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .project-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); overflow: hidden;
            transition: all 0.3s ease; display: block;
        }
        .project-card:hover {
            border-color: var(--border-hover); transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); color: var(--text);
        }
        .project-image {
            width: 100%; height: 200px; position: relative; overflow: hidden;
        }
        .project-image img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.4s ease;
        }
        .project-card:hover .project-image img { transform: scale(1.05); }

        .grad-1 { background: linear-gradient(135deg, #1a1040 0%, #2d1b69 40%, #7c5cfc 100%); }
        .grad-2 { background: linear-gradient(135deg, #0a192f 0%, #112240 40%, #2a6496 100%); }
        .grad-3 { background: linear-gradient(135deg, #1a0a2e 0%, #3d1f6d 40%, #c084fc 100%); }
        .grad-4 { background: linear-gradient(135deg, #0f0c29 0%, #302b63 40%, #24243e 100%); }
        .grad-5 { background: linear-gradient(135deg, #141e30 0%, #243b55 40%, #4a90d9 100%); }
        .grad-6 { background: linear-gradient(135deg, #1a0000 0%, #3d0f0f 40%, #c05050 100%); }

        .project-body { padding: 24px; }
        .project-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 8px; }
        .project-desc { font-size: 14px; color: var(--text-muted); line-height: 1.6; margin-bottom: 16px; }
        .project-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag {
            font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px;
            background: rgba(124,92,252,0.1); color: var(--accent-2);
            border: 1px solid rgba(124,92,252,0.15);
        }

        /* ABOUT */
        .about-content { display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: start; }
        .about-text { font-size: 16px; color: var(--text-muted); line-height: 1.8; }
        .about-text p + p { margin-top: 16px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .stat {
            padding: 24px; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: var(--radius);
        }
        .stat-number { font-size: 32px; font-weight: 700; color: #fff; letter-spacing: -1px; }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

        /* SKILLS */
        .skills-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .skill-group {
            padding: 28px; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: var(--radius);
        }
        .skill-group-title {
            font-size: 14px; font-weight: 700; color: #fff;
            margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
        }
        .skill-group-title span {
            display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; background: var(--accent);
        }
        .skill-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .skill-tag {
            font-size: 12px; padding: 4px 10px; border-radius: 6px;
            background: rgba(255,255,255,0.04); color: var(--text-muted);
            border: 1px solid rgba(255,255,255,0.06);
        }

        /* TIMELINE */
        .timeline { position: relative; padding-left: 32px; }
        .timeline::before {
            content: ''; position: absolute; left: 7px; top: 8px; bottom: 8px;
            width: 1px; background: var(--border);
        }
        .timeline-item { position: relative; padding-bottom: 28px; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item::before {
            content: ''; position: absolute; left: -29px; top: 8px;
            width: 9px; height: 9px; border-radius: 50%;
            background: var(--accent); border: 2px solid var(--bg);
        }
        .timeline-item.current::before { box-shadow: 0 0 0 4px rgba(124,92,252,0.2); }
        .timeline-role { font-size: 15px; font-weight: 600; color: #fff; }
        .timeline-company { font-size: 14px; color: var(--text-muted); }
        .timeline-dates { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

        /* CONTACT */
        .contact-section { text-align: center; padding: 120px 0; }
        .contact-section .section-title { margin-bottom: 16px; }
        .contact-desc { font-size: 16px; color: var(--text-muted); margin-bottom: 36px; }
        .contact-links { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }

        /* FOOTER */
        footer {
            padding: 40px 0; border-top: 1px solid var(--border); text-align: center;
        }
        footer p { font-size: 13px; color: var(--text-dim); }

        /* ANIMATIONS */
        .reveal {
            opacity: 0; transform: translateY(30px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        .stagger > * { transition-delay: calc(var(--i, 0) * 0.08s); }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .projects-grid { grid-template-columns: 1fr; }
            .about-content { grid-template-columns: 1fr; gap: 40px; }
            .skills-grid { grid-template-columns: 1fr; }
            .nav-links { display: none; }
        }
        @media (max-width: 600px) {
            .hero h1 { font-size: 36px; letter-spacing: -1px; }
            .hero-desc { font-size: 16px; }
            section { padding: 60px 0; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .stat { padding: 16px; }
            .stat-number { font-size: 24px; }
        }
    </style>
</head>
<body>

<canvas id="dotfield"></canvas>

<nav id="nav">
    <div class="container">
        <a href="#" class="nav-logo">IL</a>
        <div class="nav-links">
            <a href="#work">Work</a>
            <a href="#about">About</a>
            <a href="#experience">Experience</a>
            <a href="#contact">Contact</a>
        </div>
    </div>
</nav>

<!-- HERO -->
<section class="hero">
    <div class="hero-bg"></div>
    <div class="container">
        <div class="hero-content">
            <div class="hero-label">AI Creative Specialist & Product Designer</div>
            <h1>I design tools that&nbsp;make AI work&nbsp;for&nbsp;creatives.</h1>
            <p class="hero-desc">20+ years building at the intersection of design, AI, and engineering. Currently at Sett, where I've built 45+ AI production tools that generate game assets, animate characters, and ship playable ads end-to-end.</p>
            <div class="hero-links">
                <a href="https://github.com/ilanlenzner-design" class="btn btn-primary" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                    GitHub
                </a>
                <a href="https://www.linkedin.com/in/ilan-lenzner-395ba64/" class="btn btn-outline" target="_blank">LinkedIn</a>
                <a href="mailto:ilan@ilans.net" class="btn btn-outline">Email Me</a>
            </div>
        </div>
    </div>
</section>

<!-- WORK -->
<section id="work">
    <div class="container">
        <div class="reveal">
            <div class="section-label">Featured Work</div>
            <h2 class="section-title">Things I've built.</h2>
        </div>
        <div class="projects-grid stagger">

            <a href="https://github.com/ilanlenzner-design/InkForge" target="_blank" class="project-card reveal" style="--i:0">
                <div class="project-image"><img src="images/inkforge-preview.jpg" alt="InkForge"></div>
                <div class="project-body">
                    <div class="project-title">InkForge</div>
                    <p class="project-desc">Native macOS drawing app with AI-powered editing, layers, selections, texture brushes, and a Procreate-inspired UI. Built for concept art and asset creation.</p>
                    <div class="project-tags">
                        <span class="tag">Swift</span>
                        <span class="tag">macOS</span>
                        <span class="tag">AI Editing</span>
                        <span class="tag">CoreGraphics</span>
                    </div>
                </div>
            </a>

<a href="https://github.com/ilanlenzner-design/Sprite-Studio" target="_blank" class="project-card reveal" style="--i:2">
                <div class="project-image"><img src="images/spritestudio-preview.jpg" alt="Sprite Studio"></div>
                <div class="project-body">
                    <div class="project-title">Sprite Studio</div>
                    <p class="project-desc">Web-based tool for converting video sequences into sprite sheets. Features chroma key, AI-powered grid detection, real-time animation preview, and multi-format export.</p>
                    <div class="project-tags">
                        <span class="tag">JavaScript</span>
                        <span class="tag">Canvas</span>
                        <span class="tag">Gemini AI</span>
                        <span class="tag">Replicate</span>
                    </div>
                </div>
            </a>

            <a href="https://github.com/ilanlenzner-design/sett-after-effects-hub" target="_blank" class="project-card reveal" style="--i:3">
                <div class="project-image"><img src="images/settae-preview.jpg" alt="Sett After Effects Hub"></div>
                <div class="project-body">
                    <div class="project-title">Sett After Effects Hub</div>
                    <p class="project-desc">Adobe After Effects extension with 10 AI modules — image expander, upscaler, background remover, video generation (Kling), sound FX, music, voiceover (ElevenLabs), and smart copywriting.</p>
                    <div class="project-tags">
                        <span class="tag">CEP Extension</span>
                        <span class="tag">After Effects</span>
                        <span class="tag">Kling</span>
                        <span class="tag">ElevenLabs</span>
                    </div>
                </div>
            </a>

            <a href="https://github.com/ilanlenzner-design/ai-studio" target="_blank" class="project-card reveal" style="--i:4">
                <div class="project-image"><img src="images/aistudio-preview.jpg" alt="AI Studio"></div>
                <div class="project-body">
                    <div class="project-title">AI Studio</div>
                    <p class="project-desc">Modular AI platform with unlimited tools — image generation, video processing, 3D modeling, background removal. Built on Replicate API with a clean panel interface.</p>
                    <div class="project-tags">
                        <span class="tag">JavaScript</span>
                        <span class="tag">Replicate</span>
                        <span class="tag">Node.js</span>
                        <span class="tag">AI Platform</span>
                    </div>
                </div>
            </a>

        </div>
        <p style="text-align:center; margin-top:40px; color:var(--text-dim); font-size:14px;">
            See all 45+ projects on <a href="https://github.com/ilanlenzner-design?tab=repositories" target="_blank">GitHub</a>
        </p>
    </div>
</section>

<!-- ABOUT -->
<section id="about">
    <div class="container">
        <div class="reveal">
            <div class="section-label">About</div>
            <h2 class="section-title">Design meets AI engineering.</h2>
        </div>
        <div class="about-content">
            <div class="about-text reveal">
                <p>I started in motion graphics and 3D animation, moved into interactive advertising where I directed campaigns for Fortune 500 brands, then into product design for AI tools and healthcare systems.</p>
                <p>Now I build the AI systems themselves. At Sett, I architect autonomous agents that generate game assets, animate characters, and ship playable ads — designing both the tools and the AI pipelines behind them. I think in design systems and ship in code.</p>
                <p>Based in Tel Aviv. Open to opportunities where AI and creative production intersect.</p>
            </div>
            <div class="stats-grid reveal">
                <div class="stat"><div class="stat-number">20+</div><div class="stat-label">Years in design & tech</div></div>
                <div class="stat"><div class="stat-number">45+</div><div class="stat-label">AI tools built</div></div>
                <div class="stat"><div class="stat-number">15+</div><div class="stat-label">AI agent skills</div></div>
                <div class="stat"><div class="stat-number">500+</div><div class="stat-label">Ad campaigns shipped</div></div>
            </div>
        </div>
    </div>
</section>

<!-- SKILLS -->
<section id="skills">
    <div class="container">
        <div class="reveal">
            <div class="section-label">Skills</div>
            <h2 class="section-title">What I work with.</h2>
        </div>
        <div class="skills-grid">
            <div class="skill-group reveal">
                <div class="skill-group-title"><span></span> Design</div>
                <div class="skill-list">
                    <span class="skill-tag">Figma</span>
                    <span class="skill-tag">UX/UI Design</span>
                    <span class="skill-tag">Design Systems</span>
                    <span class="skill-tag">User Research</span>
                    <span class="skill-tag">Prototyping</span>
                    <span class="skill-tag">Motion Graphics</span>
                    <span class="skill-tag">3D Modeling</span>
                    <span class="skill-tag">Blender</span>
                    <span class="skill-tag">After Effects</span>
                    <span class="skill-tag">Photoshop</span>
                    <span class="skill-tag">Illustrator</span>
                </div>
            </div>
            <div class="skill-group reveal">
                <div class="skill-group-title"><span></span> AI & Creative Tech</div>
                <div class="skill-list">
                    <span class="skill-tag">AI Agents</span>
                    <span class="skill-tag">LLM Integration</span>
                    <span class="skill-tag">Claude</span>
                    <span class="skill-tag">GPT-4</span>
                    <span class="skill-tag">Prompt Engineering</span>
                    <span class="skill-tag">Replicate</span>
                    <span class="skill-tag">Midjourney</span>
                    <span class="skill-tag">Kling</span>
                    <span class="skill-tag">MiniMax</span>
                    <span class="skill-tag">ElevenLabs</span>
                    <span class="skill-tag">SAM3</span>
                    <span class="skill-tag">MCP Servers</span>
                </div>
            </div>
            <div class="skill-group reveal">
                <div class="skill-group-title"><span></span> Engineering</div>
                <div class="skill-list">
                    <span class="skill-tag">Python</span>
                    <span class="skill-tag">TypeScript</span>
                    <span class="skill-tag">JavaScript</span>
                    <span class="skill-tag">Swift</span>
                    <span class="skill-tag">React</span>
                    <span class="skill-tag">Node.js</span>
                    <span class="skill-tag">PixiJS</span>
                    <span class="skill-tag">Three.js</span>
                    <span class="skill-tag">FFmpeg</span>
                    <span class="skill-tag">AWS</span>
                    <span class="skill-tag">n8n</span>
                    <span class="skill-tag">Webpack</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- EXPERIENCE -->
<section id="experience">
    <div class="container">
        <div class="reveal">
            <div class="section-label">Experience</div>
            <h2 class="section-title">Where I've worked.</h2>
        </div>
        <div class="timeline reveal">
            <div class="timeline-item current">
                <div class="timeline-role">AI Creative Lead & Product Designer</div>
                <div class="timeline-company">Sett</div>
                <div class="timeline-dates">2024 — Present</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-role">AI & Design Innovation Lead</div>
                <div class="timeline-company">Rabin Medical Center (Clalit Health Services)</div>
                <div class="timeline-dates">2024</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-role">Product Designer & AI Workflow Developer</div>
                <div class="timeline-company">PlayBatch, Tel Aviv</div>
                <div class="timeline-dates">2022 — 2023</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-role">Product Designer</div>
                <div class="timeline-company">Bites</div>
                <div class="timeline-dates">2020 — 2022</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-role">Creative Director</div>
                <div class="timeline-company">justAd & Market Group</div>
                <div class="timeline-dates">2013 — 2020</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-role">Rich Media Specialist</div>
                <div class="timeline-company">eyeblaster (MediaMind / Sizmek)</div>
                <div class="timeline-dates">2007 — 2013</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-role">3D & Motion Specialist</div>
                <div class="timeline-company">Gorni Digital, DPSI, ScanMaster</div>
                <div class="timeline-dates">2000 — 2007</div>
            </div>
        </div>
    </div>
</section>

<!-- CONTACT -->
<section id="contact" class="contact-section">
    <div class="container">
        <div class="reveal">
            <div class="section-label">Contact</div>
            <h2 class="section-title">Let's talk.</h2>
            <p class="contact-desc">Open to AI creative, product design, and creative technology roles.</p>
            <div class="contact-links">
                <a href="mailto:ilan@ilans.net" class="btn btn-primary">ilan@ilans.net</a>
                <a href="https://www.linkedin.com/in/ilan-lenzner-395ba64/" class="btn btn-outline" target="_blank">LinkedIn</a>
                <a href="https://github.com/ilanlenzner-design" class="btn btn-outline" target="_blank">GitHub</a>
            </div>
        </div>
    </div>
</section>

<footer>
    <div class="container">
        <p>Ilan Lenzner — Tel Aviv, Israel</p>
    </div>
</footer>

<script>
    /* ── Nav scroll ── */
    const nav = document.getElementById('nav');
    window.addEventListener('scroll', () => {
        nav.classList.toggle('scrolled', window.scrollY > 50);
    });

    /* ── Reveal on scroll ── */
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });
    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    /* ── Force-field dot grid with dot-matrix banner ── */
    (function() {
        const canvas = document.getElementById('dotfield');
        const ctx = canvas.getContext('2d');
        const SPACING = 8;
        const DOT_R = 0.5;
        const PLUS_SIZE = 1.0;
        const EFFECT_RADIUS = 150;
        const REPEL_FORCE = 5;
        const HEAL_FACTOR = 0.04;
        const DAMPING = 0.92;

        // Banner messages — text, images, and videos with real colors
        const MESSAGES = [
            { text: 'ILAN LENZNER', scale: 0.9 },
            { video: 'videos/dnc4.mp4', bgFilter: 147 },
            { text: 'AI + DESIGN', scale: 0.9 },
            { video: 'videos/ilans-talk.mp4', bgFilter: 'grey' },
            { image: 'images/rhino.png' },
            { video: 'videos/portrait-anim.mp4' },
            { text: '45+ TOOLS', scale: 0.9 },
            { text: 'CREATIVE TECH', scale: 0.9 },
        ];
        const MSG_DURATION = 200;   // frames to hold each message
        const FADE_FRAMES = 50;     // frames for fade in/out

        // Preload images
        var imageCache = {};
        // Preload videos
        var videoCache = {};
        var activeVideo = null;     // currently playing video element

        MESSAGES.forEach(function(msg) {
            if (msg.image && !imageCache[msg.image]) {
                var img = new Image();
                img.src = msg.image;
                imageCache[msg.image] = img;
            }
            if (msg.video && !videoCache[msg.video]) {
                var vid = document.createElement('video');
                vid.src = msg.video;
                vid.muted = true;
                vid.loop = true;
                vid.playsInline = true;
                vid.preload = 'auto';
                vid.load();
                videoCache[msg.video] = vid;
            }
        });

        let W, H, cols, rows, particles;
        let mouseX = -9999, mouseY = -9999;
        let frame = 0;
        let msgIndex = 0;
        let litMap = null;           // Set of "col,row" strings that are lit
        let offCanvas, offCtx;       // offscreen canvas for text sampling

        function init() {
            const dpr = window.devicePixelRatio || 1;
            W = window.innerWidth;
            H = window.innerHeight;
            canvas.width = W * dpr;
            canvas.height = H * dpr;
            canvas.style.width = W + 'px';
            canvas.style.height = H + 'px';
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

            cols = Math.ceil(W / SPACING) + 2;
            rows = Math.ceil(H / SPACING) + 2;
            particles = [];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const hx = c * SPACING;
                    const hy = r * SPACING;
                    particles.push({
                        hx: hx, hy: hy,
                        x: hx, y: hy,
                        vx: 0, vy: 0,
                        col: c, row: r,
                        baseShape: (r + c) % 2 === 0 ? 'dot' : 'plus',
                        lit: 0          // 0-1 glow intensity
                    });
                }
            }

            // Create offscreen canvas for text sampling
            offCanvas = document.createElement('canvas');
            offCanvas.width = cols;
            offCanvas.height = rows;
            offCtx = offCanvas.getContext('2d');

            // Sample first message
            sampleMessage(MESSAGES[0]);
        }

        // Store lit pixels as relative offsets from center, with optional color
        var litPixels = [];   // [{dc, dr, r, g, b}, ...]
        var currentIsImage = false;
        var currentIsVideo = false;
        var currentBgFilter = null;

        function sampleMessage(msg) {
            // Stop any previously playing video
            if (activeVideo) {
                activeVideo.pause();
                activeVideo = null;
            }

            if (msg.video) {
                currentIsImage = true;
                currentIsVideo = true;
                currentBgFilter = msg.bgFilter || null;
                var vid = videoCache[msg.video];
                if (vid) {
                    vid.currentTime = 0;
                    vid.play().catch(function() {});
                    activeVideo = vid;
                    // Sample first frame immediately
                    sampleVideoFrame(vid);
                }
                return;
            }

            currentIsVideo = false;
            offCtx.clearRect(0, 0, cols, rows);
            var cx = Math.floor(cols / 2);
            var cy = Math.floor(rows / 2);

            if (msg.image) {
                currentIsImage = true;
                var img = imageCache[msg.image];
                if (img && img.complete && img.naturalWidth > 0) {
                    var aspect = img.naturalWidth / img.naturalHeight;
                    var maxH = Math.floor(rows * 0.85);
                    var maxW = Math.floor(cols * 0.5);
                    var drawH = maxH;
                    var drawW = Math.floor(drawH * aspect);
                    if (drawW > maxW) { drawW = maxW; drawH = Math.floor(drawW / aspect); }
                    offCtx.drawImage(img, cx - Math.floor(drawW/2), cy - Math.floor(drawH/2), drawW, drawH);
                }
            } else {
                currentIsImage = false;
                offCtx.fillStyle = '#fff';
                offCtx.textAlign = 'center';
                offCtx.textBaseline = 'middle';
                var text = msg.text;
                var scale = msg.scale || 0.9;
                var fontSize = Math.floor(cols * scale / Math.max(text.length, 1) * 1.6);
                fontSize = Math.max(6, Math.min(fontSize, Math.floor(rows * 0.8)));
                offCtx.font = '900 ' + fontSize + 'px sans-serif';
                offCtx.fillText(text, cx, cy);
            }

            extractLitPixels(msg);
        }

        function sampleVideoFrame(vid) {
            if (!vid || vid.readyState < 2) return;
            offCtx.clearRect(0, 0, cols, rows);
            var cx = Math.floor(cols / 2);
            var cy = Math.floor(rows / 2);
            var aspect = vid.videoWidth / vid.videoHeight;
            var maxH = Math.floor(rows * 0.85);
            var maxW = Math.floor(cols * 0.5);
            var drawH = maxH;
            var drawW = Math.floor(drawH * aspect);
            if (drawW > maxW) { drawW = maxW; drawH = Math.floor(drawW / aspect); }
            offCtx.drawImage(vid, cx - Math.floor(drawW/2), cy - Math.floor(drawH/2), drawW, drawH);
            extractLitPixels({ video: true, bgFilter: currentBgFilter });
        }

        function extractLitPixels(msg) {
            var cx = Math.floor(cols / 2);
            var cy = Math.floor(rows / 2);
            var isVisual = msg.image || msg.video;
            var imgData = offCtx.getImageData(0, 0, cols, rows).data;
            litPixels = [];
            for (var r = 0; r < rows; r++) {
                for (var c = 0; c < cols; c++) {
                    var idx = (r * cols + c) * 4;
                    var R = imgData[idx], G = imgData[idx+1], B = imgData[idx+2], A = imgData[idx+3];
                    if (A < 60) continue;
                    if (isVisual) {
                        var lum = R * 0.299 + G * 0.587 + B * 0.114;
                        if (lum > 235) continue;
                        // Chromakey: skip green-dominant pixels
                        if (G > 80 && G > R * 1.3 && G > B * 1.3) continue;
                        // Background removal per video type
                        if (msg.bgFilter === 'grey') {
                            var maxC = Math.max(R, G, B), minC = Math.min(R, G, B);
                            if (maxC - minC < 35) continue;
                        } else if (typeof msg.bgFilter === 'number') {
                            // Remove pixels near a specific luminance (uniform bg)
                            if (Math.abs(lum - msg.bgFilter) < 18) continue;
                        }
                    }
                    litPixels.push({ dc: c - cx, dr: r - cy, r: R, g: G, b: B });
                }
            }
            updateLitMap();
        }

        var litColorMap = {};  // "col,row" -> {r,g,b}

        function updateLitMap() {
            var fx = Math.floor(cols / 2 + Math.sin(frame / 180) * cols * 0.3);
            var fy = Math.floor(rows / 2 + Math.cos(frame / 130) * rows * 0.25);
            litMap = new Set();
            litColorMap = {};
            for (var i = 0; i < litPixels.length; i++) {
                var lp = litPixels[i];
                var c = fx + lp.dc;
                var r = fy + lp.dr;
                if (c >= 0 && c < cols && r >= 0 && r < rows) {
                    var key = c + ',' + r;
                    litMap.add(key);
                    if (lp.r !== undefined) {
                        litColorMap[key] = { r: lp.r, g: lp.g, b: lp.b };
                    }
                }
            }
        }

        function animate() {
            ctx.clearRect(0, 0, W, H);
            frame++;

            // Cycle messages
            var cycleFrame = frame % (MSG_DURATION + FADE_FRAMES * 2);
            if (cycleFrame === 0) {
                msgIndex = (msgIndex + 1) % MESSAGES.length;
                sampleMessage(MESSAGES[msgIndex]);
            }

            // Re-sample video frame every 3rd frame for live animation
            if (currentIsVideo && activeVideo && activeVideo.readyState >= 2 && frame % 3 === 0) {
                sampleVideoFrame(activeVideo);
            }

            // Update floating position every frame
            updateLitMap();

            // Calculate banner fade (0 to 1)
            var bannerAlpha = 1;
            if (cycleFrame < FADE_FRAMES) {
                bannerAlpha = cycleFrame / FADE_FRAMES;           // fade in
            } else if (cycleFrame > MSG_DURATION + FADE_FRAMES) {
                bannerAlpha = 1 - (cycleFrame - MSG_DURATION - FADE_FRAMES) / FADE_FRAMES;  // fade out
            }

            var radius = EFFECT_RADIUS + Math.sin(frame / 15) * 30;
            var radiusSq = radius * radius;

            for (var i = 0; i < particles.length; i++) {
                var p = particles[i];

                // Is this particle part of the text/image?
                var key = p.col + ',' + p.row;
                var isLit = litMap && litMap.has(key);
                var pixelColor = litColorMap[key] || null;

                // Smooth glow transition
                var targetLit = isLit ? bannerAlpha : 0;
                p.lit += (targetLit - p.lit) * 0.12;

                // Mouse repulsion
                var dx = p.x - mouseX;
                var dy = p.y - mouseY;
                var distSq = dx * dx + dy * dy;
                if (distSq < radiusSq && distSq > 0) {
                    var dist = Math.sqrt(distSq);
                    var strength = (1 - dist / radius) * REPEL_FORCE;
                    p.vx += (dx / dist) * strength;
                    p.vy += (dy / dist) * strength;
                }

                // Spring back
                p.vx += (p.hx - p.x) * HEAL_FACTOR;
                p.vy += (p.hy - p.y) * HEAL_FACTOR;
                p.vx *= DAMPING;
                p.vy *= DAMPING;
                p.x += p.vx;
                p.y += p.vy;

                // Determine appearance
                var glow = p.lit;
                var baseAlpha = (p.col + p.row) % 3 === 0 ? 0.18 : 0.12;
                var alpha = baseAlpha + glow * 0.65;
                var r_c, g_c, b_c;

                if (pixelColor && currentIsImage && glow > 0.05) {
                    // Image mode: interpolate from grey toward actual pixel color
                    r_c = Math.round(255 * (1 - glow) + pixelColor.r * glow);
                    g_c = Math.round(255 * (1 - glow) + pixelColor.g * glow);
                    b_c = Math.round(255 * (1 - glow) + pixelColor.b * glow);
                    alpha = baseAlpha + glow * 0.82;
                } else {
                    // Text mode: glow purple
                    r_c = Math.round(255 - glow * 131);   // 255 -> 124
                    g_c = Math.round(255 - glow * 163);   // 255 -> 92
                    b_c = Math.round(255 - glow * 3);     // 255 -> 252
                }
                var color = 'rgba(' + r_c + ',' + g_c + ',' + b_c + ',' + alpha + ')';

                // Lit particles flip shape: dots become +, pluses become dots
                var shape = p.baseShape;
                if (glow > 0.3) {
                    shape = shape === 'dot' ? 'plus' : 'dot';
                }

                if (shape === 'dot') {
                    var dotR = DOT_R + glow * (pixelColor && currentIsImage ? 1.8 : 1.2);
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, dotR, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                } else {
                    var s = PLUS_SIZE + glow * (pixelColor && currentIsImage ? 2.2 : 1.5);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1 + glow * 0.5;
                    ctx.beginPath();
                    ctx.moveTo(p.x - s, p.y);
                    ctx.lineTo(p.x + s, p.y);
                    ctx.moveTo(p.x, p.y - s);
                    ctx.lineTo(p.x, p.y + s);
                    ctx.stroke();
                }
            }

            requestAnimationFrame(animate);
        }

        // Pointer events
        document.addEventListener('mousemove', function(e) {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });
        document.addEventListener('mouseleave', function() {
            mouseX = -9999;
            mouseY = -9999;
        });
        document.addEventListener('touchmove', function(e) {
            mouseX = e.touches[0].clientX;
            mouseY = e.touches[0].clientY;
        }, { passive: true });
        document.addEventListener('touchend', function() {
            mouseX = -9999;
            mouseY = -9999;
        });

        window.addEventListener('resize', init);
        init();
        animate();
    })();
</script>

</body>
</html>
